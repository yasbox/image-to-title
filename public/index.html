<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像からタイトル生成</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>画像からタイトル生成</h1>
        
        <div class="main-content" id="mainContent">
            <div class="left-panel">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📷</div>
                    <div class="upload-text">画像をクリックまたはドラッグ&ドロップ</div>
                    <div class="upload-hint">PNG, JPG, JPEG形式をサポート</div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>

                <div class="preview-container">
                    <img id="imagePreview" alt="プレビュー">
                </div>

                <button class="generate-btn" id="generateBtn" disabled>
                    タイトルを生成
                </button>
            </div>

            <div class="right-panel" id="rightPanel">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>AIが画像を分析中...</div>
                </div>

                <div class="result-container" id="resultContainer">
                    <div class="result-title">生成されたタイトル候補</div>
                    <div class="result-text" id="resultText"></div>
                </div>

                <div class="error" id="errorContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const generateBtn = document.getElementById('generateBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const resultText = document.getElementById('resultText');
        const errorContainer = document.getElementById('errorContainer');
        const mainContent = document.getElementById('mainContent');
        const rightPanel = document.getElementById('rightPanel');

        let selectedFile = null;

        // ファイル選択処理
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', handleFileSelect);

        // ドラッグ&ドロップ処理
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('画像ファイルを選択してください。');
                return;
            }

            selectedFile = file;
            
            // プレビュー表示（リサイズされた画像を表示）
            resizeImage(file).then(resizedDataUrl => {
                imagePreview.src = resizedDataUrl;
                imagePreview.style.display = 'block';
                generateBtn.disabled = false;
                hideError();
            }).catch(error => {
                console.error('Error resizing image:', error);
                showError('画像の処理中にエラーが発生しました。');
            });
        }

        // タイトル生成処理
        generateBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            generateBtn.disabled = true;
            loading.style.display = 'flex';
            resultContainer.style.display = 'none';
            hideError();

            try {
                // 画像をリサイズしてからbase64に変換
                const resizedDataUrl = await resizeImage(selectedFile);
                const response = await fetch('/api/title', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_base64: resizedDataUrl.split(',')[1] // data:image/...の部分を除去
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                resultText.textContent = data.titles || 'タイトル生成完了';
                resultContainer.style.display = 'flex';
            } catch (error) {
                console.error('Error:', error);
                showError('タイトル生成中にエラーが発生しました。もう一度お試しください。');
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        });



        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // 元のサイズを記録
                    const originalWidth = img.width;
                    const originalHeight = img.height;
                    
                    // アスペクト比を保ちながら、最大512px以内にリサイズ
                    const maxSize = 512;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 画像をリサイズして描画
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Canvasからbase64データを取得
                    const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // サイズ情報をコンソールに出力
                    const base64Data = resizedDataUrl.split(',')[1];
                    const fileSizeBytes = Math.ceil((base64Data.length * 3) / 4);
                    const fileSizeKB = (fileSizeBytes / 1024).toFixed(2);
                    
                    console.log('=== 画像リサイズ情報 ===');
                    console.log(`元のサイズ: ${originalWidth} x ${originalHeight} px`);
                    console.log(`リサイズ後: ${width} x ${height} px`);
                    console.log(`ファイルサイズ: ${fileSizeKB} KB (${fileSizeBytes} bytes)`);
                    console.log('=====================');
                    
                    resolve(resizedDataUrl);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
        }

        function hideError() {
            errorContainer.style.display = 'none';
        }


    </script>
</body>
</html> 