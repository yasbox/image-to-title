<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç”»åƒã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ</h1>
            <button class="logout-btn" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        
        <div class="main-content" id="mainContent">
            <div class="left-panel">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                    <div class="upload-hint">PNG, JPG, JPEGå½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆ</div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>

                <div class="preview-container">
                    <img id="imagePreview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                </div>

                <button class="generate-btn" id="generateBtn" disabled>
                    ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
                </button>
            </div>

            <div class="right-panel" id="rightPanel">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>AIãŒç”»åƒã‚’åˆ†æä¸­...</div>
                </div>

                <div class="result-container" id="resultContainer">
                    <div class="result-title">ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«å€™è£œ</div>
                    <div class="result-text" id="resultText"></div>
                </div>

                <div class="error" id="errorContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const generateBtn = document.getElementById('generateBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const resultText = document.getElementById('resultText');
        const errorContainer = document.getElementById('errorContainer');
        const mainContent = document.getElementById('mainContent');
        const rightPanel = document.getElementById('rightPanel');
        const logoutBtn = document.getElementById('logoutBtn');

        let selectedFile = null;

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        logoutBtn.addEventListener('click', async () => {
            try {
                console.log('Logout button clicked')
                
                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('Logout response status:', response.status)
                
                if (response.ok) {
                    const result = await response.json()
                    console.log('Logout result:', result)
                    
                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ - æ‰‹å‹•ã§ã‚¯ãƒƒã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict; HttpOnly; Secure'
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆCookieã®å‰Šé™¤ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ï¼‰
                    setTimeout(() => {
                        window.location.href = '/login.html'
                    }, 100)
                } else {
                    console.error('Logout failed with status:', response.status)
                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•— - æ‰‹å‹•ã§ã‚¯ãƒƒã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'
                    window.location.href = '/login.html'
                }
            } catch (error) {
                console.error('Logout error:', error)
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚æ‰‹å‹•ã§ã‚¯ãƒƒã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'
                window.location.href = '/login.html'
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', handleFileSelect);

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            selectedFile = file;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸç”»åƒã‚’è¡¨ç¤ºï¼‰
            resizeImage(file).then(resizedDataUrl => {
                imagePreview.src = resizedDataUrl;
                imagePreview.style.display = 'block';
                generateBtn.disabled = false;
                hideError();
            }).catch(error => {
                console.error('Error resizing image:', error);
                showError('ç”»åƒã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            });
        }

        // ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆå‡¦ç†
        generateBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            generateBtn.disabled = true;
            loading.style.display = 'flex';
            resultContainer.style.display = 'none';
            hideError();

            try {
                // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ã‹ã‚‰base64ã«å¤‰æ›
                const resizedDataUrl = await resizeImage(selectedFile);
                const response = await fetch('/api/title', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_base64: resizedDataUrl.split(',')[1] // data:image/...ã®éƒ¨åˆ†ã‚’é™¤å»
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                resultText.textContent = data.titles || 'ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆå®Œäº†';
                resultContainer.style.display = 'flex';
            } catch (error) {
                console.error('Error:', error);
                showError('ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        });



        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // å…ƒã®ã‚µã‚¤ã‚ºã‚’è¨˜éŒ²
                    const originalWidth = img.width;
                    const originalHeight = img.height;
                    
                    // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ãªãŒã‚‰ã€æœ€å¤§512pxä»¥å†…ã«ãƒªã‚µã‚¤ã‚º
                    const maxSize = 512;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦æç”»
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Canvasã‹ã‚‰base64ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // ã‚µã‚¤ã‚ºæƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                    const base64Data = resizedDataUrl.split(',')[1];
                    const fileSizeBytes = Math.ceil((base64Data.length * 3) / 4);
                    const fileSizeKB = (fileSizeBytes / 1024).toFixed(2);
                    
                    console.log('=== ç”»åƒãƒªã‚µã‚¤ã‚ºæƒ…å ± ===');
                    console.log(`å…ƒã®ã‚µã‚¤ã‚º: ${originalWidth} x ${originalHeight} px`);
                    console.log(`ãƒªã‚µã‚¤ã‚ºå¾Œ: ${width} x ${height} px`);
                    console.log(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${fileSizeKB} KB (${fileSizeBytes} bytes)`);
                    console.log('=====================');
                    
                    resolve(resizedDataUrl);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
        }

        function hideError() {
            errorContainer.style.display = 'none';
        }


    </script>
</body>
</html> 